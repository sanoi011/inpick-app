# INPICK 소비자 워크플로우 와이드프레임 (6탭)

## Status: 요구사항 정리 완료, 구현 대기

## 전체 흐름 요약

```
탭1 우리집 찾기 → 탭2 도면/3D 매스 → 탭3 AI 디자인 → 탭4 3D 렌더링+자재수정 → 탭5 물량산출/견적 → 탭6 견적요청
```

---

## 탭1: 우리집 찾기
- **변경사항 없음** (현재 그대로)
- 주소 검색 → 건물 선택 → 평면도 자동 매칭
- 매칭된 평면도 데이터를 탭2로 전달

---

## 탭2: 도면 / 3D 매스 생성
- **목적**: 소비자 집의 3D 매스 모델 확보

### 시나리오 A: 탭1에서 평면도 매칭 성공
- 매칭된 평면도 자동 로드
- 해당 평면도 기반으로 **3D 매스 모델 자동 생성**

### 시나리오 B: 평면도 없음 → 소비자 직접 제공
- **방법 1**: 카메라 3D 스캐닝 (LiDAR/ARKit 활용 또는 사진 기반 3D 복원)
- **방법 2**: 도면 파일 업로드 (PDF/이미지)
  - 업로드된 도면을 AI가 분석하여 공간 인식
  - 인식된 데이터로 3D 매스 모델 생성

### 출력
- 3D 매스 모델 (방 구조, 벽, 문, 창문 위치)
- 탭3으로 전달

---

## 탭3: AI 디자인 상담
- **목적**: AI와 대화하며 인테리어 디자인 완성

### 레이아웃
- **왼쪽**: AI 에이전트 채팅 패널
- **오른쪽**: 캔버스 (탭2에서 생성된 3D 매스 모델 표시)

### 상담 방식
1. **부위별 지정**: 소비자가 캔버스에서 특정 부위 클릭/표시 → "여기는 이 느낌으로 해줘"
2. **전체 스타일**: "동유럽풍의 디자인으로 추천해줘" → AI가 도면 기반으로 전체 인테리어 적용
3. **혼합**: 전체 스타일 적용 후 부분 수정 가능

### AI 동작
- 캔버스의 도면/3D 매스를 컨텍스트로 인식
- 디자인 추천 시 이미지 생성 (Gemini 이미지 생성)
- 각 방별로 자재, 색상, 가구 배치 결정
- 결정사항을 프로젝트에 저장

### 출력
- 완성된 디자인 결정사항 (방별 자재, 색상, 스타일)
- 탭4로 전달

---

## 탭4: 3D 렌더링 + 자재 수정
- **목적**: 실사급 3D 렌더링으로 최종 확인 + 자재 미세조정

### 주요 기능
1. **3D 실사 렌더링**: 탭3 디자인 결과를 포토리얼리스틱 렌더링으로 표시
   - 렌더링 엔진 API 연동 (최적 엔진 찾아서 연동)
   - 각 방별 렌더링 뷰 제공

2. **검토 + 확인 체크**: 소비자가 렌더링 결과 확인

3. **자재 수정 기능**:
   - 마음에 안 드는 부분 클릭 → 오른쪽 툴바에 해당 실/부위별 자재 목록 표시
   - 자재 선택 변경 → **자동으로 부자재 + 관련 항목 모두 연동 변경**
   - 변경 후 렌더링 자동 업데이트

### 출력
- 확정된 디자인 + 자재 선정 결과
- 탭5로 전달

---

## 탭5: 물량산출 / 견적
- **목적**: 확정된 디자인의 정확한 물량 산출 + 견적

### 주요 기능
1. **물량산출**: 탭4에서 확정된 자재 기반으로 정확한 물량 계산
   - 실별 면적 × 자재 단가
   - 부자재, 시공비, 부대비 자동 산출
   - 철거, 방수, 마감, 목공, 전기, 설비 카테고리별 산출

2. **견적서 생성**:
   - 총 공사비 요약
   - 실별 상세 내역
   - 자재비 / 노무비 / 경비 분리

### 출력
- 완성된 견적서
- 탭6으로 전달

---

## 탭6: 견적요청 (RFQ)
- **목적**: 지역 사업자에게 견적 요청 발송

### 주요 기능
1. **특기사항 기입**: 소비자가 추가 요청사항 작성
   - 희망 시공 기간
   - 특별 요청 (소음 제한 시간, 거주 중 시공 여부 등)
   - 예산 범위

2. **견적요청 발송**: "견적요청" 버튼 클릭 시
   - 해당 지역 사업자 대시보드에 **추천**으로 표시
   - 사업자가 프로젝트 상세 확인 가능
   - 사업자가 견적 입찰 가능

3. **입찰 확인**: 사업자 입찰 후
   - 소비자에게 입찰 목록 표시
   - AI 분석 (최저가, 최적 추천 등)
   - 업체 선정 플로우

---

## 기술 스택

### 기존 (활용)
- Next.js 14, TypeScript, Tailwind CSS
- Supabase (Auth + DB), Vercel 배포
- Google Gemini 2.0 Flash (텍스트 AI)
- Gemini 이미지 생성 (gemini-2.0-flash-exp)
- Three.js (@react-three/fiber, @react-three/drei) - 3D 뷰어
- FloorPlan2D 컴포넌트 - SVG 평면도
- useAuth, useProjectState 훅
- 사업자 대시보드 (contractor/) - 이미 구축됨

### 신규 필요
- **3D 매스 모델링**: Three.js 기반 평면도→3D 변환
- **3D 렌더링 엔진 API**: 포토리얼리스틱 렌더링 (찾아서 연동)
- **크레딧 시스템**: Supabase 테이블 + 충전 UI
- **사업자 매칭**: 지역 기반 견적요청 발송 시스템

---

## 크레딧 시스템

### 요금 구조
- 1회 이미지 생성 = **10 크레딧**
- 10 크레딧 = **1,000원**
- 무료 사용자: **1회** 무료

### 크레딧 패키지
| 크레딧 | 가격 | 이미지 생성 횟수 |
|--------|------|-----------------|
| 10 | 1,000원 | 1회 |
| 50 | 4,500원 | 5회 (10% 할인) |
| 100 | 8,000원 | 10회 (20% 할인) |
| 300 | 21,000원 | 30회 (30% 할인) |

### DB 스키마
```sql
CREATE TABLE user_credits (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) NOT NULL UNIQUE,
  balance INTEGER DEFAULT 0,
  free_generations_used INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE credit_transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  amount INTEGER NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('CHARGE', 'USE', 'FREE', 'REFUND')),
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 렌더링 엔진 API 후보 (조사 필요)
- Chaos V-Ray (건축 시각화 표준)
- Enscape (실시간 렌더링)
- Lumion (건축 렌더링)
- NVIDIA Omniverse (클라우드 렌더링 API)
- Replicate + Stable Diffusion (AI 기반 렌더링)
- Three.js + React Three Fiber (자체 렌더링, 이미 설치됨)

---

## 현재 파일 구조 대비 변경점

### 탭 라우트 변경
| 현재 | 변경 후 |
|------|---------|
| `/project/[id]/home` (탭1) | 유지 |
| `/project/[id]/design` (탭2) | → 도면/3D 매스 생성 |
| `/project/[id]/estimate` (탭3) | → AI 디자인 상담 |
| `/project/[id]/bids` (탭4) | → 3D 렌더링+자재수정 |
| (없음) | → `/project/[id]/estimate` 물량산출/견적 (새 내용) |
| (없음) | → `/project/[id]/rfq` 견적요청 (신규) |

### 신규 라우트
- `/project/[id]/rfq/page.tsx` - 견적요청 페이지

---

## 구현 순서 (Phase별)

### Phase 1: 탭 구조 변경 + 타입 확장
- layout.tsx 6탭으로 변경
- 라우트 세그먼트 정리
- 타입 확장 (GeneratedImage, DesignMaterial, RenderView 등)

### Phase 2: 탭2 - 도면/3D 매스 생성
- 평면도 자동 로드 (탭1 연동)
- 도면 파일 업로드 + AI 분석
- Three.js 기반 평면도→3D 매스 변환

### Phase 3: 탭3 - AI 디자인 상담
- 3D 매스 모델 캔버스 표시
- AI 채팅 + 이미지 생성
- 부위별/전체 스타일 디자인 적용

### Phase 4: 탭4 - 3D 렌더링 + 자재수정
- 렌더링 엔진 연동
- 자재 수정 UI + 자동 연동 변경
- 확인/검토 체크

### Phase 5: 탭5 - 물량산출/견적
- 자재 기반 물량 자동 계산
- 견적서 생성

### Phase 6: 탭6 - 견적요청 + 사업자 연동
- 특기사항 입력 폼
- 지역 사업자 매칭 + 대시보드 연동
- 입찰 확인 플로우

---

## 이어서 작업 시
1. 이 파일(`PLAN.md`) 읽기
2. Phase 1부터 순서대로 구현
3. 각 Phase 완료 후 `npx next build` → 커밋 → 푸시
